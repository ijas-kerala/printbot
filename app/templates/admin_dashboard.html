<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - PrintBot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js for simple interactivity -->
    <script src="//unpkg.com/alpinejs" defer></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

    <nav class="bg-gray-800 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">PrintBot Admin</h1>
            <a href="/admin/logout" class="text-sm bg-red-600 px-3 py-1 rounded hover:bg-red-700">Logout</a>
        </div>
    </nav>

    <div class="container mx-auto p-4" x-data="{ tab: 'overview' }">
        <!-- Tabs -->
        <div class="flex space-x-4 mb-6 border-b border-gray-300 pb-2">
            <button @click="tab = 'overview'"
                :class="{ 'font-bold text-blue-600 border-b-2 border-blue-600': tab === 'overview' }"
                class="pb-2">Overview</button>
            <button @click="tab = 'jobs'"
                :class="{ 'font-bold text-blue-600 border-b-2 border-blue-600': tab === 'jobs' }" class="pb-2">Recent
                Jobs</button>
            <button @click="tab = 'pricing'"
                :class="{ 'font-bold text-blue-600 border-b-2 border-blue-600': tab === 'pricing' }"
                class="pb-2">Pricing</button>
        </div>

        <!-- Overview Content -->
        <div x-show="tab === 'overview'" class="space-y-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-gray-500 text-sm font-bold uppercase">Total Revenue</h3>
                    <p class="text-2xl font-bold text-green-600">₹{{ "%.2f"|format(total_revenue) }}</p>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-gray-500 text-sm font-bold uppercase">Total Jobs</h3>
                    <p class="text-2xl font-bold">{{ total_jobs }}</p>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-gray-500 text-sm font-bold uppercase">Completed</h3>
                    <p class="text-2xl font-bold text-blue-600">{{ completed_jobs }}</p>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-gray-500 text-sm font-bold uppercase">Failed</h3>
                    <p class="text-2xl font-bold text-red-600">{{ failed_jobs }}</p>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-white p-4 rounded shadow h-64">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Jobs Content -->
        <div x-show="tab === 'jobs'">
            <div class="bg-white shadow rounded overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200" id="jobsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                File</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Pages</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Cost</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Date</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="jobsBody">
                        <!-- Populated by JS -->
                        <tr>
                            <td colspan="6" class="p-4 text-center text-gray-400">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pricing Content -->
        <div x-show="tab === 'pricing'">
            <div class="bg-white shadow rounded p-6 max-w-md">
                <h3 class="text-lg font-bold mb-4">Update Pricing</h3>
                <form action="/admin/api/pricing" method="POST" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Price Per Page (₹)</label>
                        <input type="number" step="0.5" name="price" value="{{ price_per_page }}"
                            class="w-full border p-2 rounded">
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Update
                        Price</button>
                    <p class="text-xs text-gray-500 mt-2">Note: Resets on server restart currently.</p>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Fetch Chart Data
        fetch('/admin/api/stats')
            .then(res => res.json())
            .then(data => {
                const ctx = document.getElementById('revenueChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Revenue (₹)',
                            data: data.data,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            });

        // Fetch Recent Jobs
        fetch('/admin/api/jobs')
            .then(res => res.json())
            .then(jobs => {
                const tbody = document.getElementById('jobsBody');
                tbody.innerHTML = '';
                jobs.forEach(job => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">#${job.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs">${job.filename}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.page_count} (x${job.copies})</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">₹${job.total_cost}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${job.status === 'completed' ? 'bg-green-100 text-green-800' :
                            job.status.includes('failed') ? 'bg-red-100 text-red-800' :
                                'bg-yellow-100 text-yellow-800'}">
                                    ${job.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(job.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    </script>
</body>

</html>